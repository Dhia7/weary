services:
  postgres:
    image: postgres:15
    container_name: wear_postgres
    environment:
      POSTGRES_DB: wear_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: dhianaija123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - wear_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d wear_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgbouncer:
    image: bitnami/pgbouncer:1.18.0
    container_name: wear_pgbouncer
    environment:
      POSTGRESQL_HOST: postgres
      POSTGRESQL_PORT_NUMBER: 5432
      POSTGRESQL_USERNAME: postgres
      POSTGRESQL_PASSWORD: dhianaija123
      POSTGRESQL_DATABASE: wear_db
      PGBOUNCER_POOL_MODE: transaction
      PGBOUNCER_MAX_CLIENT_CONN: 1000
      PGBOUNCER_DEFAULT_POOL_SIZE: 20
      PGBOUNCER_RESERVE_POOL_SIZE: 5
      PGBOUNCER_RESERVE_POOL_TIMEOUT: 5
      PGBOUNCER_MAX_DB_CONNECTIONS: 50
      PGBOUNCER_MAX_USER_CONNECTIONS: 50
      PGBOUNCER_SERVER_RESET_QUERY: DISCARD ALL
      PGBOUNCER_SERVER_CHECK_DELAY: 30
      PGBOUNCER_SERVER_CHECK_QUERY: select 1
      PGBOUNCER_SERVER_LIFETIME: 600
      PGBOUNCER_SERVER_IDLE_TIMEOUT: 600
      PGBOUNCER_IDLE_TRANSACTION_TIMEOUT: 0
      PGBOUNCER_QUERY_TIMEOUT: 0
      PGBOUNCER_CLIENT_TLS_SSLMODE: disable
    ports:
      - "6432:5432"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - wear_network
    restart: unless-stopped

volumes:
  postgres_data:

networks:
  wear_network:
    driver: bridge
